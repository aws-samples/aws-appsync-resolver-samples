# Todo Search API - CDK Example

This CDK app provides an implementation of an AppSync API that uses an [Amazon OpenSearch Serverless](https://aws.amazon.com/opensearch-service/features/serverless/) Collection as a data source. The data source is configured as an HTTP data source and uses an attached role to sign the requests.

This advanced example demonstrates how you can connect to just about any data source using an HTTP resolver, including any AWS service.

The API allows you to create an index, create a document, and search documents. The schema uses a Todo type as an example.

```graphql
type Todo {
  id: ID!
  title: String
  description: String
  owner: String
}
```

The app uses the [AppSync Helper construct](../constructs/appsync-helper/) for a quick setup.

```sh
lib
├── appsync
│   ├── codegen
│   │   ├── graphql
│   │   │   ├── mutations.ts
│   │   │   └── queries.ts
│   │   ├── API.ts
│   │   └── index.ts
│   ├── resolvers
│   │   ├── Mutation.createIndex.[aoss].ts
│   │   ├── Mutation.indexTodo.[aoss].ts
│   │   ├── Query.search.[aoss].ts
│   │   └── utils.ts
│   └── schema.graphql
├── appsync-helper.ts
└── aoss-search-app-stack.ts
```

The [appsync](./lib/appsync-helper.ts) folder contains schema and the resolver code. This project uses unit resolvers, but you can expand it to use pipeline resolvers if needed.

## Init

Install all the dependencies. From the [project folder](./)

```sh
npm install
```

## Codegen

This TypeScript projects uses types generated by [Amplify Codegen](https://docs.amplify.aws/cli-legacy/graphql-transformer/codegen/). To populate your codegen and generate it after you update your schema, run the command:

```sh
npm run codegen
```

## Deploy the stack

To deploy the stack, from the top folder:

```sh
npm run cdk deploy -- -O output.json
```

Once deployed, you can find your API **SearchTodoAPI** in the AWS console.

## Test the API

First, begin by creating an index:

```graphql
mutation CreateIndex {
  createIndex(index: "todos")
}
```

Next, create a document in the index.

```graphql
mutation IndexDoc {
  indexTodo(input: {description: "a new todo", id: "a-given-id", owner: "John", title: "things need doing"})
}
```

Then, lets search for some items. Lets find all the todos that belong to owners who's name begin with 'john':

```graphql
query Search {
  search(filter: {owner: {regexp: "john.*"}}) {
    items {
      id
      owner
      title
      description
    }
    nextToken
    total
  }
}
```

## Connect to an app

You can use the info in [./output.json](./output.json) to configure your Amplify client in your app. See [Building a client application](https://docs.aws.amazon.com/appsync/latest/devguide/building-a-client-app.html).

## Destroy the stack

To destroy the stack and all the created resources:

```sh
npm run cdk destroy
```
