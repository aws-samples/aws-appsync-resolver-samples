# Local PubSub API - CDK Example

This CDK app provides an implementation of an AppSync API that can be used to implement a simple pub sub API for a chat system. The API uses a local NONE resolver. This means that no data is saved. When a message is published to the system, it is immediately made available to clients that have subscribed to receive message. The system works with anonymous users and authenticated users.

The core of the API is built around the `Message` type

```graphql
type Message @aws_api_key @aws_cognito_user_pools {
 id: ID!
 text: String!
 from: String!
 kind: MSG_KIND!
 to: String
 createdAt: AWSDateTime
}

```

The app uses the [AppSync Helper construct](../constructs/appsync-helper/) for a quick setup.

```sh
lib
├── appsync
│   ├── codegen
│   │   ├── graphql
│   │   │   ├── mutations.ts
│   │   │   ├── queries.ts
│   │   │   └── subscriptions.ts
│   │   ├── API.ts
│   │   └── index.ts
│   ├── resolvers
│   │   ├── Mutation.publish.[NONE].ts
│   │   ├── Subscription.onPublish.[NONE].ts
│   │   └── utils.d.ts
│   └── schema.graphql
├── appsync-helper.ts
└── pub-sub-app-stack.ts
```

The [appsync](./lib/appsync/) folder contains schema and the resolver code. This project uses unit resolvers, but you can expand it to use pipeline resolvers if needed.

## Init

Install all the dependencies. From the [project folder](./)

```sh
npm install
```

## Codegen

This TypeScript projects uses types generated by [Amplify Codegen](https://docs.amplify.aws/cli-legacy/graphql-transformer/codegen/). To populate your codegen and generate it after you update your schema, run the command:

```sh
npm run codegen
```

## Deploy the stack

To deploy the stack, from the top folder:

```sh
npm run cdk deploy -- -O output.json
```

Once deployed, you can find your API **LocalMessageAPI** in the AWS AppSync console.

## Testing the API

In the AppSync console, head to the **Queries Editor**. Using the 'API Key' authorization mode, set up a subscription:

```graphql
subscription Sub {
  onPublish {
    createdAt
    from
    id
    kind
    text
    to
  }
}
```

In a separate browser tab or window, navigate to the **Queries Editor** page again and send this mutation:

```graphql
mutation Pub {
  publish(input: {kind: ALL, text: "Hello World!"}) {
    createdAt
    from
    id
    kind
    text
    to
  }
}
```

In your first tab, you receive the message. Next, try it out as a signed in cognito user. You can head to the Amazon Cognito console to set up a user or sign up a user named `tester` with these commands:

```sh
$ CLIENT_ID="<USERPOOLSWEBCLIENTID from output.json file>"
$ EMAIL="<your email address>"
$ aws cognito-idp sign-up --client-id $CLIENT_ID --username tester --password TempPassword1234! --user-attributes Name=email,Value=$EMAIL
```

You will receive a confirmation code at your email address. Then confirm your sign-up:

```sh
$ aws cognito-idp confirm-sign-up --client-id $CLIENT_ID --username tester --confirmation-code <CODE>
```

In the tab where you sent the mutation, log in as the `tester` user. Then send this message to yourself:

```graphql
mutation Pub {
  publish(input: {kind: DIRECT, text: "hello", to: "tester"}) {
    createdAt
    from
    id
    kind
    text
    to
  }
}
```

In the subscription tab, you do not see the message. The subscription uses enhanced filtering and only allows anonymous users (those using the API KEY) to receive message sent to ALL. Stop your subscription and change authorization mode to Cognito User Pools. Sign in if needed, and restart the subscription. Send yourself another message, which you then receive.

Try this again by creating other users and sending DIRECT or ALL messages to the various users so see that DIRECT messages are only received by the users they are addressed to.

## Connect to an app

You can use the info in [./output.json](./output.json) to configure your Amplify client in your app. See [Building a client application](https://docs.aws.amazon.com/appsync/latest/devguide/building-a-client-app.html).

## Destroy the stack

To destroy the stack and all the created resources:

```sh
npm run cdk destroy
```
